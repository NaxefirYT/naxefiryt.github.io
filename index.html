<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCR Custom Role Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-picker@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d121c; /* Deeper, rich dark blue-gray */
        }
        .tab-button.active {
            border-color: #818cf8; /* Lighter indigo for active tab */
            background-color: #4f46e5; /* Stronger indigo */
            color: #ffffff;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.6); /* More prominent shadow for active tab */
        }
        .tab-button {
            transition: all 0.3s ease;
            color: #d1d5db; /* Light gray for inactive tabs */
        }
        .form-section { display: none; }
        .form-section.active { display: block; }
        
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        .input-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .input-item-inline {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.5rem;
        }
        label {
            font-weight: 500;
            color: #e2e8f0; /* Lighter label text */
        }
        input[type="checkbox"] {
            cursor: pointer;
        }
        input, select, textarea {
            background-color: #1f2937; /* Darker input background */
            border: 1px solid #4b5563; /* Subtle border */
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: #e5e7eb; /* Light text color */
            transition: all 0.2s ease-in-out;
            width: 100%;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #818cf8; /* Lighter indigo focus border */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5); /* Glowing focus effect */
        }
        fieldset {
            border: 1px solid #374151; /* Darker border for fieldsets */
            transition: box-shadow 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* Default subtle shadow */
            background-color: #1a202c; /* Slightly lighter than body, but darker than inputs */
        }
        fieldset:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); /* More prominent shadow on hover */
        }
        .dynamic-list-item {
            display: grid;
            gap: 1rem;
            align-items: start;
            border: 1px solid #4b5563;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #1f2937; /* Consistent with input background */
        }
        .dynamic-list-item-simple {
             display: flex;
             gap: 0.5rem;
             align-items: center;
        }
        .dynamic-list-item-simple input[type="text"],
        .dynamic-list-item-simple select {
            flex-grow: 1;
        }
        .remove-item-btn {
            background-color: #e11d48; /* Stronger rose color */
            color: white;
            padding: 0.6rem;
            border-radius: 0.5rem;
            line-height: 1;
            transition: background-color 0.2s;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(225, 29, 72, 0.3);
        }
        .remove-item-btn:hover {
            background-color: #be123c; /* Darker rose on hover */
            box-shadow: 0 4px 10px rgba(225, 29, 72, 0.5);
        }
        /* Adjusted styling for "Add" buttons - more subtle, less prominent */
        .add-btn { 
            background-color: #374151; /* Darker gray for a subtle look */
            color: #e2e8f0; /* Light text */
            font-weight: 500;
            padding: 0.75rem 1.5rem; /* Slightly more padding */
            border-radius: 0.5rem;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border: 1px solid #4b5563; /* Subtle border */
        }
        .add-btn:hover {
            background-color: #4b5563; /* Slightly lighter gray on hover */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .rich-text-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .color-picker-btn {
            width: 38px;
            height: 38px;
            min-width: 38px;
            border-radius: 0.375rem;
            border: 1px solid #4b5563;
            cursor: pointer;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .rich-text-controls select {
            flex-grow: 1;
            padding: 0.5rem;
            background-color: #374151; /* Darker background for controls */
            border-color: #4b5563;
            color: #e5e7eb;
        }
        .rich-text-preview {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: #e5e7eb;
            min-height: 40px;
            margin-top: 0.5rem;
            word-wrap: break-word;
            white-space: pre-wrap; /* Preserve whitespace and newlines */
            font-family: 'Inter', sans-serif; /* Consistent font */
        }
        #downloadFileName {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            color: #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-white tracking-tight">UCR Custom Role Creator</h1>
            <p class="text-gray-400 mt-2 text-lg">—Å–¥–µ–ª–∞–Ω–æ Naxefir —Å <span class="text-orange-400">üß°</span> —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è <a href="https://discord.gg/3m2BtRsuUB" target="_blank" class="text-orange-400 hover:underline">MANGO ü•≠</a></p>
            <p class="text-gray-400 mt-3 text-lg">–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ä–æ–ª–µ–π UCR.</p>
        </header>

        <div class="bg-gray-800/50 backdrop-blur-sm p-4 rounded-xl shadow-2xl mb-8 flex flex-wrap gap-4 justify-center sticky top-4 z-10 border border-gray-700">
            <label class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition-all duration-300 shadow-lg hover:shadow-indigo-500/50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L6.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å YAML</span>
                <input type="file" id="yamlUploader" class="hidden" accept=".yml,.yaml">
            </label>
            <button id="downloadButton" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 shadow-lg hover:shadow-green-500/50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.293a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                <span>–°–∫–∞—á–∞—Ç—å YAML</span>
            </button>
             <button id="resetButton" class="flex items-center gap-2 bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 shadow-lg hover:shadow-rose-500/50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                <span>–°–±—Ä–æ—Å–∏—Ç—å</span>
            </button>
        </div>

        <div class="mb-4">
            <label for="downloadFileName" class="block text-gray-400 text-sm font-bold mb-2">–ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è):</label>
            <input type="text" id="downloadFileName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-700 text-gray-200 border-gray-600" value="custom_role">
        </div>

        <div class="mb-8 border-b border-gray-700">
            <nav class="flex flex-wrap -mb-px" id="tabContainer">
                <button class="tab-button active text-lg py-3 px-6 border-b-2 border-transparent rounded-t-lg" data-tab="general">–û—Å–Ω–æ–≤–Ω–æ–µ</button>
                <button class="tab-button text-lg py-3 px-6 border-b-2 border-transparent rounded-t-lg" data-tab="health">–ó–¥–æ—Ä–æ–≤—å–µ</button>
                <button class="tab-button text-lg py-3 px-6 border-b-2 border-transparent rounded-t-lg" data-tab="stats">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</button>
                <button class="tab-button text-lg py-3 px-6 border-b-2 border-transparent rounded-t-lg" data-tab="inventory">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
                <button class="tab-button text-lg py-3 px-6 border-b-2 border-transparent rounded-t-lg" data-tab="spawn">–°–ø–∞–≤–Ω</button>
                <button class="tab-button text-lg py-3 px-6 border-b-2 border-transparent rounded-t-lg" data-tab="escape">–ü–æ–±–µ–≥</button>
            </nav>
        </div>

        <form id="roleForm" class="space-y-10">
            
            <div id="general" class="form-section active space-y-8">
                <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</legend>
                    <div class="input-group">
                        <div class="input-item"><label for="id">ID</label><input type="number" id="id" data-path="id"></div>
                        <div class="input-item"><label for="name">–ò–º—è (rich text)</label><input type="text" id="name" data-path="name"><div id="name_preview" class="rich-text-preview"></div></div>
                        <div class="input-item"><label for="nickname">–ù–∏–∫–Ω–µ–π–º</label><input type="text" id="nickname" data-path="nickname"></div>
                        <div class="input-item">
						<label for="custom_info">–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (rich text)</label>
						<textarea id="custom_info" data-path="custom_info" rows="2" class="w-full"></textarea>
						<div id="custom_info_preview" class="rich-text-preview"></div>
						</div>
                    </div>
                     <div class="input-item mt-6">
                        <label for="role_observer_info">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è (rich text)</label>
                        <textarea id="role_observer_info" data-path="role_observer_info" rows="2" class="w-full"></textarea>
                        <div id="role_observer_info_preview" class="rich-text-preview"></div>
                    </div>
                </fieldset>
                
                <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</legend>
                    <div class="input-group">
                         <div class="input-item"><label for="badge_name">–¢–µ–∫—Å—Ç –∑–Ω–∞—á–∫–∞</label><input type="text" id="badge_name" data-path="badge_name"></div>
                         <div class="input-item"><label for="badge_color">–¶–≤–µ—Ç –∑–Ω–∞—á–∫–∞</label><select id="badge_color" data-path="badge_color"></select></div>
                         <div class="input-item"><label for="role">–†–æ–ª—å (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è)</label><select id="role" data-path="role"></select></div>
                         <div class="input-item"><label for="role_appearance">–í–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–∞–∫ —É</label><select id="role_appearance" data-path="role_appearance"></select></div>
                         <div class="input-item"><label for="ragdoll_appearance">Ragdoll –∫–∞–∫ —É</label><select id="ragdoll_appearance" data-path="ragdoll_appearance"></select></div>
                         <div class="input-item"><label for="team">–ö–æ–º–∞–Ω–¥–∞</label><select id="team" data-path="team"></select></div>
                    </div>
                    <div class="mt-6"><div class="input-item-inline"><input type="checkbox" id="override_role_name" data-path="override_role_name" class="w-5 h-5"><label for="override_role_name">–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–º—è —Ä–æ–ª–∏</label></div></div>
                </fieldset>

                <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–†–∞–∑–º–µ—Ä –∏ –ú–∞—Å—à—Ç–∞–±</legend>
                    <div class="input-group">
                        <div class="input-item"><label for="scale_x">–ú–∞—Å—à—Ç–∞–± X</label><input type="number" step="0.1" id="scale_x" data-path="scale.x"></div>
                        <div class="input-item"><label for="scale_y">–ú–∞—Å—à—Ç–∞–± Y</label><input type="number" step="0.1" id="scale_y" data-path="scale.y"></div>
                        <div class="input-item"><label for="scale_z">–ú–∞—Å—à—Ç–∞–± Z</label><input type="number" step="0.1" id="scale_z" data-path="scale.z"></div>
                    </div>
                </fieldset>
            </div>

            <div id="health" class="form-section space-y-8">
                 <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–ó–¥–æ—Ä–æ–≤—å–µ (HP)</legend>
                    <div class="input-group">
                        <div class="input-item"><label for="health_amount">–ù–∞—á–∞–ª—å–Ω–æ–µ HP</label><input type="number" id="health_amount" data-path="health.amount"></div>
                        <div class="input-item"><label for="health_maximum">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ HP</label><input type="number" id="health_maximum" data-path="health.maximum"></div>
                    </div>
                </fieldset>
                <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">Hume –©–∏—Ç</legend>
                    <div class="input-group">
                        <div class="input-item"><label for="hume_shield_amount">–ù–∞—á–∞–ª—å–Ω—ã–π —â–∏—Ç</label><input type="number" id="hume_shield_amount" data-path="health.hume_shield"></div>
                        <div class="input-item"><label for="max_hume_shield">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —â–∏—Ç</label><input type="number" id="max_hume_shield" data-path="health.max_hume_shield"></div>
                        <div class="input-item"><label for="hume_shield_regeneration_amount">–†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–≤ —Å–µ–∫)</label><input type="number" step="0.1" id="hume_shield_regeneration_amount" data-path="health.hume_shield_regeneration_amount"></div>
                        <div class="input-item"><label for="hume_shield_regeneration_delay">–ó–∞–¥–µ—Ä–∂–∫–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (—Å–µ–∫)</label><input type="number" step="0.1" id="hume_shield_regeneration_delay" data-path="health.hume_shield_regeneration_delay"></div>
                    </div>
                </fieldset>
                <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–µ –ó–¥–æ—Ä–æ–≤—å–µ (AHP)</legend>
                    <div class="input-group">
                        <div class="input-item"><label for="ahp_amount">–ù–∞—á–∞–ª—å–Ω–æ–µ AHP</label><input type="number" id="ahp_amount" data-path="ahp.amount"></div>
                        <div class="input-item"><label for="ahp_limit">–õ–∏–º–∏—Ç AHP</label><input type="number" id="ahp_limit" data-path="ahp.limit"></div>
                        <div class="input-item"><label for="ahp_decay">–°–∫–æ—Ä–æ—Å—Ç—å —Ä–∞—Å–ø–∞–¥–∞</label><input type="number" step="0.1" id="ahp_decay" data-path="ahp.decay"></div>
                        <div class="input-item"><label for="ahp_efficacy">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (0-1)</label><input type="number" step="0.1" id="ahp_efficacy" data-path="ahp.efficacy"></div>
                        <div class="input-item"><label for="ahp_sustain">–ó–∞–¥–µ—Ä–∂–∫–∞ —Ä–∞—Å–ø–∞–¥–∞ (—Å–µ–∫)</label><input type="number" step="0.1" id="ahp_sustain" data-path="ahp.sustain"></div>
                    </div>
                    <div class="mt-6"><div class="input-item-inline"><input type="checkbox" id="ahp_persistant" data-path="ahp.persistant" class="w-5 h-5"><label for="ahp_persistant">–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π (–Ω–µ —Ä–∞—Å–ø–∞–¥–∞–µ—Ç—Å—è)</label></div></div>
                </fieldset>
            </div>
            
            <div id="stats" class="form-section space-y-8">
                 <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å</legend>
                    <div class="input-group">
                        <div class="input-item"><label for="stamina_regen_multiplier">–ú–Ω–æ–∂–∏—Ç–µ–ª—å —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</label><input type="number" step="0.1" id="stamina_regen_multiplier" data-path="stamina.regen_multiplier"></div>
                        <div class="input-item"><label for="stamina_usage_multiplier">–ú–Ω–æ–∂–∏—Ç–µ–ª—å —Ä–∞—Å—Ö–æ–¥–∞</label><input type="number" step="0.1" id="stamina_usage_multiplier" data-path="stamina.usage_multiplier"></div>
                    </div>
                    <div class="mt-6"><div class="input-item-inline"><input type="checkbox" id="stamina_infinite" data-path="stamina.infinite" class="w-5 h-5"><label for="stamina_infinite">–ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å</label></div></div>
                </fieldset>
                <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–ü—Ä–æ—á–µ–µ</legend>
                    <div class="input-group">
                         <div class="input-item"><label for="damage_multiplier">–ú–Ω–æ–∂–∏—Ç–µ–ª—å —É—Ä–æ–Ω–∞</label><input type="number" step="0.1" id="damage_multiplier" data-path="damage_multiplier"></div>
                        <div class="input-item"><label for="max_scp330_candies">–ú–∞–∫—Å. –∫–æ–Ω—Ñ–µ—Ç SCP-330</label><input type="number" id="max_scp330_candies" data-path="max_scp330_candies"></div>
                    </div>
                </fieldset>
                <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–≠—Ñ—Ñ–µ–∫—Ç—ã</legend>
                    <div id="effectsContainer" class="space-y-4"></div>
                    <button type="button" id="addEffectButton" class="mt-4 add-btn">–î–æ–±–∞–≤–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç</button>
                </fieldset>
            </div>
            
            <div id="inventory" class="form-section space-y-8">
                <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</legend>
                    <div id="inventoryContainer" class="space-y-2"></div>
                    <button type="button" id="addInventoryItemButton" class="mt-4 add-btn">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
                </fieldset>
                <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–ö–∞—Å—Ç–æ–º–Ω—ã–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</legend>
                     <p class="text-sm text-gray-400 mb-4">–î–æ–±–∞–≤—å—Ç–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –ø–æ –æ–¥–Ω–æ–º—É (—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–ª–∞–≥–∏–Ω CustomItems).</p>
                    <div id="customInventoryContainer" class="space-y-2"></div>
                    <button type="button" id="addCustomInventoryItemButton" class="mt-4 add-btn">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç</button>
                </fieldset>
                <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–ü–∞—Ç—Ä–æ–Ω—ã</legend>
                    <div id="ammoContainer" class="space-y-4"></div>
                    <button type="button" id="addAmmoButton" class="mt-4 add-btn">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ç—Ä–æ–Ω—ã</button>
                </fieldset>
                <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</legend>
                    <div id="customInventoryLimitsContainer" class="space-y-4"></div>
                    <button type="button" id="addCustomInventoryLimitButton" class="mt-4 add-btn">–î–æ–±–∞–≤–∏—Ç—å –ª–∏–º–∏—Ç</button>
                </fieldset>
                 <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–ö–æ–Ω—Ñ–µ—Ç—ã SCP-330</legend>
                    <div id="inventoryCandyContainer" class="space-y-4"></div>
                    <button type="button" id="addInventoryCandyButton" class="mt-4 add-btn">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–µ—Ç—É</button>
                </fieldset>
            </div>

            <div id="spawn" class="form-section space-y-8">
                <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–°–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ —Å–ø–∞–≤–Ω–µ</legend>
                     <div class="input-group">
                        <div class="input-item"><label for="spawn_broadcast_duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–µ–∫)</label><input type="number" id="spawn_broadcast_duration" data-path="spawn_broadcast_duration"></div>
                        <div class="input-item"><label for="spawn_hint_duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ (—Å–µ–∫)</label><input type="number" id="spawn_hint_duration" data-path="spawn_hint_duration"></div>
                     </div>
                     <div class="input-item mt-4">
                        <label for="spawn_broadcast">–°–æ–æ–±—â–µ–Ω–∏–µ (Broadcast)</label>
                        <textarea id="spawn_broadcast" data-path="spawn_broadcast" rows="3" class="w-full"></textarea>
                        <div id="spawn_broadcast_preview" class="rich-text-preview"></div>
                    </div>
                     <div class="input-item mt-4">
                        <label for="spawn_hint">–ü–æ–¥—Å–∫–∞–∑–∫–∞ (Hint)</label>
                        <textarea id="spawn_hint" data-path="spawn_hint" rows="2" class="w-full"></textarea>
                        <div id="spawn_hint_preview" class="rich-text-preview"></div>
                    </div>
                </fieldset>
                 <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ø–∞–≤–Ω–∞</legend>
                     <div class="input-group">
                        <div class="input-item"><label for="spawn_chance">–®–∞–Ω—Å —Å–ø–∞–≤–Ω–∞ (%)</label><input type="number" id="spawn_chance" data-path="spawn_settings.spawn_chance"></div>
                        <div class="input-item"><label for="min_players">–ú–∏–Ω. –∏–≥—Ä–æ–∫–æ–≤</label><input type="number" id="min_players" data-path="spawn_settings.min_players"></div>
                        <div class="input-item"><label for="max_players">–ú–∞–∫—Å. –∏–≥—Ä–æ–∫–æ–≤</label><input type="number" id="max_players" data-path="spawn_settings.max_players"></div>
                        <div class="input-item"><label for="spawn_type">–¢–∏–ø —Å–ø–∞–≤–Ω–∞</label><select id="spawn_type" data-path="spawn_settings.spawn"></select></div>
                     </div>
                </fieldset>
                <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–¢—Ä–µ–±—É–µ–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è</legend>
                    <div id="requiredPermissionContainer" class="space-y-2"></div>
                    <button type="button" id="addRequiredPermissionButton" class="mt-4 add-btn">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ</button>
                </fieldset>
                 <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ –≥—Ä—É–ø–ø—ã</legend>
                    <div id="ignoreGroupsContainer" class="space-y-2"></div>
                    <button type="button" id="addIgnoreGroupButton" class="mt-4 add-btn">–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
                </fieldset>
                 <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–ó–∞–º–µ–Ω—è–µ–º—ã–µ —Ä–æ–ª–∏</legend>
                    <div id="canReplaceRolesContainer" class="space-y-2"></div>
                    <button type="button" id="addCanReplaceRoleButton" class="mt-4 add-btn">–î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å</button>
                </fieldset>
                 <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–ó–æ–Ω—ã —Å–ø–∞–≤–Ω–∞</legend>
                    <div id="spawnZonesContainer" class="space-y-2"></div>
                    <button type="button" id="addSpawnZoneButton" class="mt-4 add-btn">–î–æ–±–∞–≤–∏—Ç—å –∑–æ–Ω—É</button>
                </fieldset>
                 <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–ö–æ–º–Ω–∞—Ç—ã —Å–ø–∞–≤–Ω–∞</legend>
                    <div id="spawnRoomsContainer" class="space-y-2"></div>
                    <button type="button" id="addSpawnRoomButton" class="mt-4 add-btn">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                </fieldset>
				<fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
					<legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–¢–æ—á–∫–∏ —Å–ø–∞–≤–Ω–∞</legend>
					<p class="text-sm text-gray-400 mb-4">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–æ—á–∫—É —Å–ø–∞–≤–Ω–∞ –ø–µ—Ä–µ–¥ —ç—Ç–∏–º —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–¥–Ω—ã ucr spawnpoint create.</p>
					<div id="spawnPointsContainer" class="space-y-2"></div>
					<button type="button" id="addSpawnPointButton" class="mt-4 add-btn">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</button>
				</fieldset>
            </div>

            <div id="escape" class="form-section space-y-8">
                <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                     <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–õ–æ–≥–∏–∫–∞ –ø–æ–±–µ–≥–∞</legend>
                    <div class="mt-4 input-item-inline"><input type="checkbox" id="can_escape" data-path="can_escape" checked class="w-5 h-5"><label for="can_escape">–ú–æ–∂–µ—Ç —Å–±–µ–∂–∞—Ç—å</label></div>
                </fieldset>
                <fieldset class="bg-gray-800 p-6 rounded-xl shadow-md">
                    <legend class="text-xl font-semibold mb-4 px-2 text-indigo-300">–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–æ–±–µ–≥–∞</legend>
                    <div id="escapeRulesContainer" class="space-y-4"></div>
                    <button type="button" id="addEscapeRuleButton" class="mt-4 add-btn">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ</button>
                </fieldset>
            </div>

        </form>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg text-lg opacity-0 transition-opacity duration-300">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let config = {};
            const form = document.getElementById('roleForm');
            const downloadFileNameInput = document.getElementById('downloadFileName');

            const enums = {
                roleTypeIds: ['None','Scp173','ClassD','Spectator','Scp106','NtfSpecialist','Scp049','Scientist','Scp079','ChaosConscript','Scp096','Scp0492','NtfSergeant','NtfCaptain','NtfPrivate','Tutorial','FacilityGuard','Scp939','CustomRole','ChaosRifleman','ChaosRepressor','ChaosMarauder','Overwatch','Filmmaker','Scp3114','Flamingo','AlphaFlamingo','ZombieFlamingo'],
                teamEnums: ['SCPs','FoundationForces','ChaosInsurgency','Scientists','ClassD','Dead','OtherAlive','Flamingo'],
                badgeColors: ['pink','red','brown','silver','light_green','crimson','cyan','aqua','deep_pink','tomato','yellow','magenta','blue_green','orange','lime','green','carmine','nickel','mint','army_green','pumpkin'],
                effectTypes: ['AmnesiaItems','AmnesiaVision','AntiScp207','Asphyxiated','Bleeding','Blinded','BodyshotReduction','Burned','Concussed','Corroding','Deafened','Decontaminating','Disabled','Ensnared','Exhausted','Flashed','Hemorrhage','Hypothermia','InsufficientLighting','Invigorated','Invisible','Poisoned','RainbowTaste','Scp1853','Scp207','Scp268','Scanned','SeveredHands','Sinkhole','SilentWalk','SoundtrackMute','SpawnProtected','Stained','Strangled','Traumatized','Vitality','MovementBoost','Scp500', 'CardiacArrest', 'Ghostly'],
                itemTypes: ['KeycardJanitor','KeycardScientist','KeycardResearchCoordinator','KeycardZoneManager','KeycardGuard','KeycardMTFPrivate','KeycardContainmentEngineer','KeycardMTFOperative','KeycardMTFCaptain','KeycardFacilityManager','KeycardChaosInsurgency','KeycardO5','Radio','GunCOM15','Medkit','Flashlight','MicroHID','SCP500','SCP207','Ammo12gauge','GunE11SR','GunCrossvec','Ammo556x45','GunFSP9','GunLogicer','GrenadeHE','GrenadeFlash','Ammo44cal','Ammo762x39','Ammo9x19','GunCOM18','SCP018','SCP268','Adrenaline','Painkillers','Coin','ArmorLight','ArmorCombat','ArmorHeavy','GunRevolver','GunAK','GunShotgun','SCP330','SCP2176','SCP244a','SCP244b','SCP1853','ParticleDisruptor','GunCom45','SCP1576','Jailbird','AntiSCP207','GunFRMG0','GunA7','Lantern','Snowball', 'Coal', 'SpecialCoal', 'Tape'],
                ammoTypes: ['Nato9','Nato556','Nato762','Ammo12Gauge','Ammo44Cal'],
                spawnTypes: ['CompleteRandomSpawn','ZoneSpawn','RoomsSpawn','SpawnPointSpawn','KeepRoleSpawn','KeepCurrentPositionSpawn','ClassDCell','RoleSpawn'],
                zoneTypes: ['LightContainment', 'HeavyContainment', 'Entrance', 'Surface'],
                roomTypes: ['LczArmory','LczCurve','LczStraight','Lcz330','Lcz914','LczCrossing','LczTCross','LczCafe','LczPlants','LczToilets','LczAirlock','Lcz173','LczClassDSpawn','LczCheckpointB','LczGlassBox','LczCheckpointA','Hcz079','HczEzCheckpointA','HczEzCheckpointB','HczArmory','Hcz939','HczHid','Hcz049','HczChkpA','HczCrossing','Hcz106','HczNuke','HczTesla','HczTestRoom','HczElevatorA','HczElevatorB','HczServers','HczChkpB','HczTCross','HczCurve','Hcz096','EzVent','EzIntercom','EzGateA','EzDownstairsPcs','EzCurve','EzPcs','EzCrossing','EzCollapsedTunnel','EzConference','EzStraight','EzCafeteria','EzUpstairsPcs','EzGateB','EzShelter','Pocket','Surface', 'EzCheckpointHallway'],
                candyKinds: ['None', 'Rainbow', 'Yellow', 'Purple', 'Red', 'Green', 'Blue', 'Pink', 'Random'],
                inventoryLimitTypes: ['Keycard', 'Medical', 'Radio', 'Firearm', 'Grenade', 'SCPItem', 'SpecialWeapon', 'Ammo', 'Armor']
            };
            
            function populateSelect(selectElement, options) {
                if (!selectElement) return;
                selectElement.innerHTML = '';
                options.forEach(option => selectElement.add(new Option(option, option)));
            }

            function initialize() {
                populateSelect(document.getElementById('badge_color'), enums.badgeColors);
                populateSelect(document.getElementById('role'), enums.roleTypeIds);
                populateSelect(document.getElementById('role_appearance'), enums.roleTypeIds);
                populateSelect(document.getElementById('ragdoll_appearance'), enums.roleTypeIds);
                populateSelect(document.getElementById('team'), enums.teamEnums);
                populateSelect(document.getElementById('spawn_type'), enums.spawnTypes);
                
                ['name', 'custom_info', 'role_observer_info', 'spawn_broadcast', 'spawn_hint'].forEach(id => setupRichTextTools(id));
                
                resetConfig();
                bindUI();

                // Ensure downloadFileName input value is displayed
                downloadFileNameInput.value = getDefaultConfig().download_file_name;
            }

            function getDefaultConfig() {
                return {
                    id: 1, name: 'Janitor', override_role_name: false, nickname: 'D-%dnumber%',
                    custom_info: 'Janitor', 
                    role_observer_info: '<color=#fa5757><b>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —â–∏—Ç —É–≤–µ–ª–∏—á–µ–Ω –¥–æ 200 –µ–¥–∏–Ω–∏—Ü</b></color>', 
                    badge_name: 'Janitor', badge_color: 'pumpkin',
                    role: 'ClassD', team: 'ClassD', role_appearance: 'ClassD', ragdoll_appearance: 'ClassD', is_friend_of: [],
                    health: { 
                        amount: 100, 
                        maximum: 100,
                        hume_shield: 0,
                        max_hume_shield: 200,
                        hume_shield_regeneration_amount: 2,
                        hume_shield_regeneration_delay: 7.5
                    },
                    ahp: { amount: 0, limit: 75, decay: 1.2, efficacy: 0.7, sustain: 0, persistant: false },
                    effects: [],
                    stamina: { regen_multiplier: 1, usage_multiplier: 1, infinite: false },
                    max_scp330_candies: 2, can_escape: true, role_after_escape: { default: 'InternalRole Spectator' },
                    scale: { x: 1, y: 1, z: 1 },
                    spawn_broadcast: 'You are a <color=orange><b>Janitor</b></color>!', spawn_broadcast_duration: 5,
                    spawn_hint: 'This hint will be shown as a Janitor!', spawn_hint_duration: 5,
                    inventory: ['Flashlight', 'KeycardJanitor'], 
                    custom_items_inventory: [], 
                    ammo: { Nato9: 10 },
                    custom_inventory_limits: {},
                    inventory_candy: [],
                    damage_multiplier: 1,
                    spawn_settings: {
                        can_replace_roles: ['ClassD'], max_players: 10, min_players: 1, spawn_chance: 60,
                        spawn: 'RoomsSpawn', spawn_zones: [], spawn_rooms: ['LczClassDSpawn'],
                        spawn_points: [], required_permission: [],
                        ignore_groups: []
                    },
                    custom_flags: [], ignore_spawn_system: false,
                    download_file_name: 'custom_role' // Default for download filename
                };
            }

            function resetConfig() {
                config = getDefaultConfig();
                updateUIFromConfig();
                downloadFileNameInput.value = config.download_file_name; // Set default for filename input
            }
            
            function updateUIFromConfig() {
                form.removeEventListener('input', updateConfigFromUI);
                const defaultConfig = getDefaultConfig();
                config = deepMerge(defaultConfig, config);

                form.querySelectorAll('[data-path]').forEach(input => {
                    const value = getObjectValueByPath(config, input.dataset.path);
                    if (value === undefined || value === null) return;
                    if (input.type === 'checkbox') input.checked = !!value;
                    else input.value = value;
                });

                // Set download file name value
                downloadFileNameInput.value = config.download_file_name || getDefaultConfig().download_file_name;


                // Dynamic lists population
                populateDynamicList('effectsContainer', config.effects || [], createEffectItem, 'addEffectButton');
                populateDynamicList('inventoryContainer', config.inventory || [], createInventoryItem, 'addInventoryItemButton');
                populateDynamicList('customInventoryContainer', config.custom_items_inventory || [], createCustomInventoryItem, 'addCustomInventoryItemButton');
                populateDynamicList('ammoContainer', Object.entries(config.ammo || {}), createAmmoItem, 'addAmmoButton');
                populateDynamicList('customInventoryLimitsContainer', Object.entries(config.custom_inventory_limits || {}), createInventoryLimitItem, 'addCustomInventoryLimitButton');
                populateDynamicList('inventoryCandyContainer', config.inventory_candy || [], createInventoryCandyItem, 'addInventoryCandyButton');

                // Spawn settings dynamic lists
                populateDynamicList('canReplaceRolesContainer', config.spawn_settings?.can_replace_roles || [], createSimpleSelectItem(enums.roleTypeIds), 'addCanReplaceRoleButton');
                populateDynamicList('spawnZonesContainer', config.spawn_settings?.spawn_zones || [], createSimpleSelectItem(enums.zoneTypes), 'addSpawnZoneButton');
                populateDynamicList('spawnRoomsContainer', config.spawn_settings?.spawn_rooms || [], createSimpleSelectItem(enums.roomTypes), 'addSpawnRoomButton');
				populateDynamicList('spawnPointsContainer', config.spawn_settings?.spawn_points || [], createSimpleTextInput, 'addSpawnPointButton');
                populateDynamicList('requiredPermissionContainer', config.spawn_settings?.required_permission || [], createSimpleTextInput, 'addRequiredPermissionButton');
                populateDynamicList('ignoreGroupsContainer', config.spawn_settings?.ignore_groups || [], createSimpleTextInput, 'addIgnoreGroupButton');
				
                populateDynamicList('escapeRulesContainer', Object.entries(config.role_after_escape || {}), createEscapeRuleItem, 'addEscapeRuleButton');
                
                // Update rich text previews
                ['name', 'custom_info', 'role_observer_info', 'spawn_broadcast', 'spawn_hint'].forEach(id => {
                    const input = document.getElementById(id);
                    const preview = document.getElementById(`${id}_preview`);
                    if (input && preview) {
                        preview.innerHTML = parseRichText(input.value);
                    }
                });

                form.addEventListener('input', updateConfigFromUI);
            }

            function updateConfigFromUI() {
                const newConfig = {};
                form.querySelectorAll('[data-path]').forEach(el => {
                    if (el.closest('.dynamic-list-item, .dynamic-list-item-simple')) return; 
                    const path = el.dataset.path;
                    const value = el.type === 'checkbox' ? el.checked : (el.type === 'number' ? parseFloat(el.value) || 0 : el.value);
                    setObjectValueByPath(newConfig, path, value);
                });

                // Update download file name in config
                newConfig.download_file_name = downloadFileNameInput.value;

                // Update dynamic lists in config
                newConfig.effects = getDynamicObjectList('#effectsContainer');
                newConfig.inventory = getDynamicSimpleList('#inventoryContainer');
                newConfig.custom_items_inventory = getDynamicSimpleList('#customInventoryContainer', 'input');
                newConfig.ammo = getDynamicKeyValueList('#ammoContainer', true);
                newConfig.custom_inventory_limits = getDynamicKeyValueList('#customInventoryLimitsContainer', true);
                newConfig.inventory_candy = getDynamicSimpleList('#inventoryCandyContainer');
                
                if (!newConfig.spawn_settings) newConfig.spawn_settings = {};
                newConfig.spawn_settings.can_replace_roles = getDynamicSimpleList('#canReplaceRolesContainer');
                newConfig.spawn_settings.spawn_zones = getDynamicSimpleList('#spawnZonesContainer');
                newConfig.spawn_settings.spawn_rooms = getDynamicSimpleList('#spawnRoomsContainer');
				newConfig.spawn_settings.spawn_points = getDynamicSimpleList('#spawnPointsContainer', 'input');
                newConfig.spawn_settings.required_permission = getDynamicSimpleList('#requiredPermissionContainer', 'input');
                newConfig.spawn_settings.ignore_groups = getDynamicSimpleList('#ignoreGroupsContainer', 'input');

                newConfig.role_after_escape = getDynamicKeyValueList('#escapeRulesContainer');
                
                config = deepMerge(config, newConfig);

                // Update rich text previews on input
                ['name', 'custom_info', 'role_observer_info', 'spawn_broadcast', 'spawn_hint'].forEach(id => {
                    const input = document.getElementById(id);
                    const preview = document.getElementById(`${id}_preview`);
                    if (input && preview) {
                        preview.innerHTML = parseRichText(input.value);
                    }
                });
            }

            function bindUI() {
                document.getElementById('tabContainer').addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-button')) {
                        document.querySelectorAll('.tab-button, .form-section').forEach(el => el.classList.remove('active'));
                        e.target.classList.add('active');
                        document.getElementById(e.target.dataset.tab).classList.add('active');
                    }
                });
                
                form.addEventListener('input', updateConfigFromUI);
                downloadFileNameInput.addEventListener('input', updateConfigFromUI); // Listen for changes on filename input
                document.getElementById('downloadButton').addEventListener('click', downloadYAML);
                document.getElementById('yamlUploader').addEventListener('change', uploadYAML);
                document.getElementById('resetButton').addEventListener('click', () => {
                   if (window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ø–æ–ª—è –¥–æ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
                       resetConfig();
                       showToast('–§–æ—Ä–º–∞ —Å–±—Ä–æ—à–µ–Ω–∞.', 'info');
                   }
                });
            }

            function getDynamicObjectList(containerSelector) {
                const list = [];
                document.querySelectorAll(`${containerSelector} .dynamic-list-item`).forEach(item => {
                    const obj = {};
                    item.querySelectorAll('[data-subpath]').forEach(sub => {
                        obj[sub.dataset.subpath] = sub.type === 'checkbox' ? sub.checked : (sub.type === 'number' ? parseFloat(sub.value) || 0 : sub.value);
                    });
                    list.push(obj);
                });
                return list;
            }
            function getDynamicSimpleList(containerSelector, inputType = 'select') {
                return Array.from(document.querySelectorAll(`${containerSelector} .dynamic-list-item-simple ${inputType}`)).map(el => el.value).filter(Boolean);
            }
            function getDynamicKeyValueList(containerSelector, valueIsNumber = false) {
                const obj = {};
                document.querySelectorAll(`${containerSelector} .dynamic-list-item`).forEach(item => {
                    const keyInput = item.querySelector('[data-subpath="key"]');
                    const valueInput = item.querySelector('[data-subpath="value"]');
                    if (keyInput && valueInput) {
                        const key = keyInput.value;
                        let value = valueInput.value;
                        if (key) obj[key] = valueIsNumber ? parseFloat(value) || 0 : value;
                    }
                });
                return obj;
            }

            function populateDynamicList(containerId, items, createItemFn, addButtonId) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                items.forEach(item => container.appendChild(createItemFn(item)));
                const oldButton = document.getElementById(addButtonId);
                const newButton = oldButton.cloneNode(true);
                oldButton.parentNode.replaceChild(newButton, oldButton);
                newButton.addEventListener('click', () => { 
                    container.appendChild(createItemFn()); 
                    updateConfigFromUI();
                });
                container.addEventListener('click', e => {
                    if (e.target.closest('.remove-item-btn')) {
                        e.target.closest('.dynamic-list-item, .dynamic-list-item-simple').remove();
                        updateConfigFromUI();
                    }
                });
            }
            
            const createSelectWithOptions = (options, selected) => options.map(o => `<option value="${o}" ${o === selected ? 'selected' : ''}>${o}</option>`).join('');

            function createEffectItem(effect = { effect_type: 'Scp207', duration: -1, intensity: 1, removable: false }) {
                const div = document.createElement('div');
                div.className = 'dynamic-list-item';
                div.style.gridTemplateColumns = '3fr 1fr 1fr 1fr auto';
                div.innerHTML = `
                    <div class="input-item"><label>–¢–∏–ø —ç—Ñ—Ñ–µ–∫—Ç–∞</label><select data-subpath="effect_type">${createSelectWithOptions(enums.effectTypes, effect.effect_type)}</select></div>
                    <div class="input-item"><label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label><input type="number" data-subpath="duration" value="${effect.duration}"></div>
                    <div class="input-item"><label>–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å</label><input type="number" min="1" max="255" data-subpath="intensity" value="${effect.intensity}"></div>
                    <div class="input-item-inline pt-6"><input type="checkbox" data-subpath="removable" ${effect.removable ? 'checked' : ''} class="w-5 h-5"><label>–°–Ω–∏–º–∞–µ–º—ã–π</label></div>
                    <button type="button" class="remove-item-btn">X</button>
                `;
                return div;
            }
            
            function createSimpleSelectItem(options) {
                return function(item = options[0]) {
                    const div = document.createElement('div');
                    div.className = 'dynamic-list-item-simple';
                    div.innerHTML = `<select class="flex-grow">${createSelectWithOptions(options, item)}</select><button type="button" class="remove-item-btn">X</button>`;
                    return div;
                }
            }
            const createInventoryItem = createSimpleSelectItem(enums.itemTypes);
            function createCustomInventoryItem(item = '') {
                const div = document.createElement('div');
                div.className = 'dynamic-list-item-simple';
                div.innerHTML = `<input type="text" value="${item}" class="flex-grow" placeholder="CustomItemName"><button type="button" class="remove-item-btn">X</button>`;
                return div;
            }
            function createAmmoItem(entry = [enums.ammoTypes[0], 30]) {
                const div = document.createElement('div');
                div.className = 'dynamic-list-item';
                div.style.gridTemplateColumns = '2fr 1fr auto';
                div.innerHTML = `
                    <div class="input-item"><label>–¢–∏–ø –ø–∞—Ç—Ä–æ–Ω–æ–≤</label><select data-subpath="key">${createSelectWithOptions(enums.ammoTypes, entry[0])}</select></div>
                    <div class="input-item"><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label><input type="number" data-subpath="value" value="${entry[1]}"></div>
                    <button type="button" class="remove-item-btn">X</button>`;
                return div;
            }

            function createInventoryLimitItem(entry = [enums.inventoryLimitTypes[0], 1]) {
                const div = document.createElement('div');
                div.className = 'dynamic-list-item';
                div.style.gridTemplateColumns = '2fr 1fr auto';
                div.innerHTML = `
                    <div class="input-item"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select data-subpath="key">${createSelectWithOptions(enums.inventoryLimitTypes, entry[0])}</select></div>
                    <div class="input-item"><label>–õ–∏–º–∏—Ç</label><input type="number" data-subpath="value" value="${entry[1]}"></div>
                    <button type="button" class="remove-item-btn">X</button>`;
                return div;
            }

            function createInventoryCandyItem(item = enums.candyKinds[0]) {
                const div = document.createElement('div');
                div.className = 'dynamic-list-item-simple';
                div.innerHTML = `<select class="flex-grow">${createSelectWithOptions(enums.candyKinds, item)}</select><button type="button" class="remove-item-btn">X</button>`;
                return div;
            }

            function createSimpleTextInput(item = '') {
                const div = document.createElement('div');
                div.className = 'dynamic-list-item-simple';
                div.innerHTML = `<input type="text" value="${item}" class="flex-grow" placeholder="–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ/–ì—Ä—É–ø–ø–∞"><button type="button" class="remove-item-btn">X</button>`;
                return div;
            }

            function createEscapeRuleItem(entry = ['default', 'InternalRole Spectator']) {
                const div = document.createElement('div');
                div.className = 'dynamic-list-item';
                div.style.gridTemplateColumns = '2fr 2fr auto';
                div.innerHTML = `
                    <div class="input-item"><label>–£—Å–ª–æ–≤–∏–µ</label><input type="text" data-subpath="key" value="${entry[0]}"></div>
                    <div class="input-item"><label>–†–µ–∑—É–ª—å—Ç–∞—Ç</label><input type="text" data-subpath="value" value="${entry[1]}"></div>
                    <button type="button" class="remove-item-btn">X</button>`;
                return div;
            }
            
            function setupRichTextTools(inputId) {
                const input = document.getElementById(inputId);
                if (!input) return;

                const toolsWrapper = document.createElement('div');
                toolsWrapper.className = 'rich-text-controls';

                const pickerBtn = document.createElement('button');
                pickerBtn.type = 'button';
                pickerBtn.className = 'color-picker-btn';
                const picker = new Picker({ 
                    parent: pickerBtn, 
                    alpha: false 
                });
                picker.onDone = color => {
                    pickerBtn.style.backgroundColor = color.rgbaString;
                    const hex = color.hex.substring(0, 7);
                    insertTextAtCursor(input, `<color=${hex}>`, `</color>`);
                };
                
                const tagSelect = document.createElement('select');
                const tags = { '': '–í—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–≥...', '<b>': '–ñ–∏—Ä–Ω—ã–π', '<i>': '–ö—É—Ä—Å–∏–≤', '<u>': '–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π', '<size=20>': '–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞' };
                for (const tag in tags) {
                    tagSelect.add(new Option(tags[tag], tag));
                }
                tagSelect.onchange = () => {
                    if (tagSelect.value) {
                        const closingTag = tagSelect.value.startsWith('<size') ? '</size>' : `</${tagSelect.value.substring(1)}`;
                        insertTextAtCursor(input, tagSelect.value, closingTag);
                        tagSelect.value = '';
                    }
                };
                
                toolsWrapper.appendChild(pickerBtn);
                toolsWrapper.appendChild(tagSelect);
                input.parentNode.insertBefore(toolsWrapper, input.nextSibling); // Insert after input

                const previewDiv = document.getElementById(`${inputId}_preview`);
                if (previewDiv) {
                    input.addEventListener('input', () => {
                        previewDiv.innerHTML = parseRichText(input.value);
                    });
                     // Initial preview update
                    previewDiv.innerHTML = parseRichText(input.value);
                }
            }

            function insertTextAtCursor(input, textStart, textEnd = '') {
                const startPos = input.selectionStart;
                const endPos = input.selectionEnd;
                const text = input.value;
                const selection = text.substring(startPos, endPos);
                
                input.value = text.substring(0, startPos) + textStart + selection + textEnd + text.substring(endPos, text.length);
                input.focus();
                input.selectionStart = startPos + textStart.length;
                input.selectionEnd = input.selectionStart + selection.length;
                
                input.dispatchEvent(new Event('input', { bubbles: true })); // Trigger input event for preview update
            }

            // Function to parse rich text tags into HTML
            function parseRichText(text) {
                let html = text.replace(/\n/g, '<br>'); // Convert newlines to <br> for display

                // Order matters for nested tags, parse inner most first if possible or handle carefully
                html = html.replace(/<color=(#?[0-9a-fA-F]{6}|[a-zA-Z]+)>(.*?)<\/color>/g, '<span style="color: $1;">$2</span>');
                html = html.replace(/<b>(.*?)<\/b>/g, '<strong>$1</strong>');
                html = html.replace(/<i>(.*?)<\/i>/g, '<em>$1</em>');
                html = html.replace(/<u>(.*?)<\/u>/g, '<u>$1</u>'); // HTML <u> tag
                html = html.replace(/<size=(\d+)>(.*?)<\/size>/g, '<span style="font-size: $1px;">$2</span>'); // Simple pixel size

                return html;
            }

            function downloadYAML() {
                updateConfigFromUI();
                try {
                    const tempConfig = JSON.parse(JSON.stringify(config)); // Deep copy to modify for dump
                    
                    // Remove download_file_name from the actual YAML output
                    delete tempConfig.download_file_name; 

                    // Fields that might require literal block scalar for newlines
                    const richTextFields = ['custom_info', 'role_observer_info', 'spawn_broadcast', 'spawn_hint'];

                    richTextFields.forEach(field => {
                        let value = getObjectValueByPath(tempConfig, field);
                        if (typeof value === 'string' && value.includes('\n')) {
                            // Append an extra newline to encourage js-yaml to use literal block scalar '|'
                            // Only append if it doesn't already end with a newline to avoid double newlines for plain strings
                            if (!value.endsWith('\n')) {
                                setObjectValueByPath(tempConfig, field, value + '\n');
                            }
                        }
                    });

                    const yamlString = jsyaml.dump(tempConfig, { 
                        indent: 2, 
                        lineWidth: -1, // Disable line wrapping
                        skipInvalid: true,
                        noCompatMode: true // Helps with some quoting issues, though not guaranteed for all edge cases
                    });
                    
                    const blob = new Blob([yamlString], { type: 'application/x-yaml' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    let fileName = downloadFileNameInput.value.trim();
                    if (!fileName) fileName = getDefaultConfig().download_file_name; // Fallback to default if empty
                    
                    // Basic filename sanitization
                    fileName = fileName.replace(/[^a-zA-Z0-9_\-]/g, '_'); 
                    a.download = `${fileName}.yml`;
                    a.click();
                    URL.revokeObjectURL(url);
                    a.remove();
                    showToast('YAML —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');
                } catch (e) { showToast(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ YAML! ${e.message}`, 'error'); }
            }
            function uploadYAML(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        config = jsyaml.load(e.target.result) || {};
                        updateUIFromConfig();
                        showToast('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', 'success');
                    } catch (err) { showToast(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ${err.message}`, 'error'); }
                };
                reader.readAsText(file);
                event.target.value = '';
            }
            function getObjectValueByPath(obj, path) { return path.split('.').reduce((acc, part) => acc && acc[part], obj); }
            function setObjectValueByPath(obj, path, value) {
                const keys = path.split('.'), lastKey = keys.pop();
                const lastObj = keys.reduce((o, key) => o[key] = o[key] || {}, obj);
                lastObj[lastKey] = value;
            }
            const isObject = (item) => (item && typeof item === 'object' && !Array.isArray(item));
            function deepMerge(target, source) {
                const output = { ...target };
                if (isObject(target) && isObject(source)) {
                    Object.keys(source).forEach(key => {
                        if (isObject(source[key]) && key in target && isObject(target[key])) {
                            output[key] = deepMerge(target[key], source[key]);
                        } else {
                            output[key] = source[key];
                        }
                    });
                }
                return output;
            }
            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg text-lg transition-opacity duration-300';
                toast.classList.add(type === 'error' ? 'bg-rose-500' : (type === 'info' ? 'bg-blue-500' : 'bg-green-500'));
                toast.classList.remove('opacity-0');
                setTimeout(() => toast.classList.add('opacity-0'), 3000);
            }
            
            initialize();
        });
    </script>
</body>
</html>
